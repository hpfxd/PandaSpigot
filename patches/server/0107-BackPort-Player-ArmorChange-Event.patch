From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: SachaWildCode <sacha.loumachi@gmail.com>
Date: Mon, 27 Jan 2025 18:40:15 +0100
Subject: [PATCH] BackPort-Player-ArmorChange-Event


diff --git a/src/main/java/net/minecraft/server/EntityLiving.java b/src/main/java/net/minecraft/server/EntityLiving.java
index 32752dfad24bc7883b1ab52e29834f1aa6fa60c6..203e5580f2d4b9bd58aa72d5254b78452ce20693 100644
--- a/src/main/java/net/minecraft/server/EntityLiving.java
+++ b/src/main/java/net/minecraft/server/EntityLiving.java
@@ -15,7 +15,9 @@ import java.util.ArrayList;
 import com.google.common.base.Function;
 import com.google.common.collect.Lists;
 import org.bukkit.craftbukkit.event.CraftEventFactory;
+import org.bukkit.craftbukkit.inventory.CraftItemStack;
 import org.bukkit.entity.LivingEntity;
+import org.bukkit.entity.Player;
 import org.bukkit.entity.Vehicle;
 import org.bukkit.event.entity.EntityDamageEvent;
 import org.bukkit.event.entity.EntityDamageEvent.DamageModifier;
@@ -28,6 +30,7 @@ import co.aikar.timings.SpigotTimings; // Spigot
 // PaperSpigot start
 import org.bukkit.Bukkit;
 import org.spigotmc.event.entity.EntityDismountEvent;
+import org.spigotmc.event.player.PlayerArmorChangeEvent;
 // PaperSpigot end
 
 public abstract class EntityLiving extends Entity {
@@ -1492,7 +1495,33 @@ public abstract class EntityLiving extends Entity {
                 ItemStack itemstack1 = this.getEquipment(j);
 
                 if (!ItemStack.matches(itemstack1, itemstack)) {
-                    ((WorldServer) this.world).getTracker().a((Entity) this, (Packet) (new PacketPlayOutEntityEquipment(this.getId(), j, itemstack1)));
+                    // PandaSpigot start - PlayerArmorChangeEvent backport from Paper
+                    if (this instanceof EntityPlayer && j >= 1) { // Check if armor slot (1-4)
+                        final org.bukkit.inventory.ItemStack oldItem = CraftItemStack.asBukkitCopy(itemstack);
+                        final org.bukkit.inventory.ItemStack newItem = CraftItemStack.asBukkitCopy(itemstack1);
+                        final PlayerArmorChangeEvent.SlotType slotType;
+                        switch (j) {
+                            case 1:
+                                slotType = PlayerArmorChangeEvent.SlotType.FEET;
+                                break;
+                            case 2:
+                                slotType = PlayerArmorChangeEvent.SlotType.LEGS;
+                                break;
+                            case 3:
+                                slotType = PlayerArmorChangeEvent.SlotType.CHEST;
+                                break;
+                            case 4:
+                                slotType = PlayerArmorChangeEvent.SlotType.HEAD;
+                                break;
+                            default:
+                                continue;
+                        }
+                        new PlayerArmorChangeEvent((Player) this.getBukkitEntity(), slotType, oldItem, newItem)
+                                .callEvent();
+                        ((WorldServer) this.world).getTracker().a((Entity) this,
+                                (Packet) (new PacketPlayOutEntityEquipment(this.getId(), j, itemstack1)));
+                    }
+                    // PandaSpigot end
                     if (itemstack != null) {
                         this.c.a(itemstack.B());
                     }
