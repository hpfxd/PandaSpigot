From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: uRyanxD <familiarodrigues123ro@gmail.com>
Date: Wed, 2 Jul 2025 16:37:23 -0300
Subject: [PATCH] Optimise non-flush packet sending


diff --git a/src/main/java/net/minecraft/server/NetworkManager.java b/src/main/java/net/minecraft/server/NetworkManager.java
index c0f98ad7132ec80ae77affa47bd2ab703fc65f9b..65238c4c05bef73aa44d1c238ccda76630be9eb9 100644
--- a/src/main/java/net/minecraft/server/NetworkManager.java
+++ b/src/main/java/net/minecraft/server/NetworkManager.java
@@ -255,6 +255,16 @@ public class NetworkManager extends SimpleChannelInboundHandler<Packet> {
             // PandaSpigot end
         } else {
             // PandaSpigot start - Simplify
+            // PandaSpigot start - optimise packets that are not flushed
+            // note: since the type is not dynamic here, we need to actually copy the old executor code
+            // into two branches. On conflict, just re-copy - no changes were made inside the executor code.
+            if (!flush) {
+                io.netty.util.concurrent.AbstractEventExecutor.LazyRunnable run = () -> {
+                    this.doSendPacket(packet, enumprotocol, enumprotocol1, agenericfuturelistener, flush);
+                };
+                this.channel.eventLoop().execute(run);
+            } else {
+            // PandaSpigot end
             this.channel.eventLoop().execute(() -> {
                 /*
                 if (enumprotocol != enumprotocol1) {
@@ -270,6 +280,7 @@ public class NetworkManager extends SimpleChannelInboundHandler<Packet> {
                 */
                 doSendPacket(packet, enumprotocol, enumprotocol1, agenericfuturelistener, flush);
             });
+            }
             // PandaSpigot end
         }
 
