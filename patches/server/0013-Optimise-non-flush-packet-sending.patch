From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: uRyanxD <familiarodrigues123ro@gmail.com>
Date: Wed, 2 Jul 2025 16:37:23 -0300
Subject: [PATCH] Optimise non-flush packet sending


diff --git a/src/main/java/net/minecraft/server/NetworkManager.java b/src/main/java/net/minecraft/server/NetworkManager.java
index 0b7fda26cde48e579761d44876e98f39f3ca0c1e..9948a34ab7b146a5564c1377e606b19d7df49990 100644
--- a/src/main/java/net/minecraft/server/NetworkManager.java
+++ b/src/main/java/net/minecraft/server/NetworkManager.java
@@ -269,6 +269,18 @@ public class NetworkManager extends SimpleChannelInboundHandler<Packet> {
             }
             // PandaSpigot end
         } else {
+            // PandaSpigot - optimize packet that are not flushed
+            if (!flush) {
+                io.netty.util.concurrent.AbstractEventExecutor.LazyRunnable run = () -> {
+                    doSendPacket(packet, enumprotocol, enumprotocol1, player, agenericfuturelistener, flush);
+                };
+                this.channel.eventLoop().execute(run);
+            } else {
+                this.channel.eventLoop().execute(() -> {
+                    doSendPacket(packet, enumprotocol, enumprotocol1, player, agenericfuturelistener, flush);
+                });
+            }
+            /*
             this.channel.eventLoop().execute(new Runnable() {
                 public void run() {
                     if (enumprotocol != enumprotocol1) {
@@ -303,6 +315,7 @@ public class NetworkManager extends SimpleChannelInboundHandler<Packet> {
                     // PandaSpigot end
                 }
             });
+            */
         }
 
     }
